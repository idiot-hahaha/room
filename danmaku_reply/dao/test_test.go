package dao

import (
	"danmaku/danmaku_reply/model"
	"encoding/json"
	"fmt"
	"io"
	"net/http"
	"os"
	"path/filepath"
	"testing"
	"time"
)

var testVector = "[1.91957131e-02 1.20085388e-01 1.59598365e-01 6.70658797e-02 5.00748418e-02 -2.59187203e-02 5.64681999e-02 -9.28577632e-02 -3.76114286e-02 6.32384093e-03 -4.28877845e-02 4.02830867e-03 4.72778874e-03 3.24675851e-02 4.95197959e-02 5.29818274e-02 -4.04454581e-02 -2.14837659e-02 -3.02760433e-02 2.20858436e-02 -1.60775885e-01 8.08078200e-02 -2.80131046e-02 8.06255862e-02 -2.85814591e-02 5.35818562e-02 1.26382504e-02 4.79190797e-02 5.71112381e-03 -3.25830504e-02 -2.61571910e-02 8.00957829e-02 1.47316176e-02 -3.24082226e-02 -4.12552059e-02 -9.68339574e-03 5.00827562e-04 -1.56286791e-01 -6.77877516e-02 4.88779098e-02 1.88975856e-02 -7.97722116e-02 2.43868157e-02 5.46693197e-03 1.10657085e-02 -7.77949207e-03 -2.20388379e-02 3.50319929e-02 1.06080212e-01 -4.72453609e-03 -5.78185618e-02 2.34566331e-02 -5.92035763e-02 -6.09013066e-02 -7.78568387e-02 6.60292655e-02 1.78600550e-02 -8.11271518e-02 7.57634118e-02 -2.43454780e-02 9.09024663e-03 6.87524751e-02 -3.97271030e-02 3.60238105e-02 5.77254146e-02 -6.30517304e-02 -8.77819210e-02 2.84299124e-02 1.45351617e-02 -4.18620333e-02 -6.09528273e-02 1.83539074e-02 7.72607028e-02 -1.88079905e-02 9.43158567e-03 -5.06037623e-02 -2.17474420e-02 -3.18190977e-02 2.43603215e-02 -3.49250585e-02 4.67639081e-02 -4.70386669e-02 3.92342210e-02 1.94040127e-02 -3.30973230e-02 2.53315438e-02 -2.63806758e-03 7.00825006e-02 6.98782951e-02 -3.73870917e-02 -8.25273171e-02 -4.34262045e-02 -9.70547572e-02 1.45785371e-02 -2.78158560e-02 3.92692350e-02 1.16925989e-03 1.92388790e-04 -7.57028684e-02 8.60969424e-02 2.88487989e-02 2.29221098e-02 -3.57373878e-02 3.54775004e-02 2.45242212e-02 2.40351856e-02 -8.79047662e-02 1.44878421e-02 -2.73459591e-02 -8.52087438e-02 -1.44945867e-02 4.79919463e-02 -4.62026000e-02 -5.00965025e-03 5.72109707e-02 -5.80548868e-02 -3.13618332e-02 2.64306013e-02 -2.34356392e-02 1.55485841e-02 -1.91461705e-02 -3.77386212e-02 -4.94927168e-03 9.59073752e-02 5.87535352e-02 4.47579026e-02 6.50169253e-02 -8.88410933e-33 8.52444544e-02 1.26364324e-02 5.76431789e-02 9.03414190e-02 2.25082878e-02 -2.90105492e-02 -2.35911105e-02 -6.75426573e-02 -6.44759014e-02 -8.70767683e-02 -1.64986812e-02 -2.39179675e-02 -4.09978889e-02 -3.09389713e-03 2.49698050e-02 -1.18342154e-01 -2.00170111e-02 3.90376411e-02 -7.62236398e-03 1.26223668e-01 -1.07739016e-01 2.30691861e-03 3.93508002e-03 -1.73428934e-02 -4.45553847e-02 -3.18518467e-02 8.25000554e-02 3.15841357e-03 5.12051722e-03 3.60783190e-03 1.00530930e-01 -3.14028710e-02 8.14436451e-02 2.90747862e-02 3.88876647e-02 -5.74764833e-02 -4.57873270e-02 -1.83596332e-02 5.51990382e-02 1.61928553e-02 -1.55425072e-02 -1.93224028e-02 5.90646500e-03 -4.04033363e-02 -1.15880286e-02 6.17916919e-02 5.18475100e-02 5.11258282e-02 -2.27067918e-02 1.71411317e-02 -8.40456039e-02 1.96278654e-02 -1.22257639e-02 4.10588197e-02 -5.46055064e-02 -5.03100008e-02 1.41674624e-04 2.67022587e-02 3.48007381e-02 2.81967167e-02 -4.85028066e-02 2.65087634e-02 -4.79759229e-03 -1.38822183e-01 9.22235027e-02 -2.41662357e-02 1.12707205e-02 7.29610920e-02 -9.47542936e-02 3.91784944e-02 5.63311577e-02 3.21452841e-02 6.91322014e-02 2.38994882e-02 6.48374762e-03 1.73736028e-02 1.23578846e-01 -2.84599736e-02 8.67334902e-02 6.10371828e-02 -2.50962973e-02 1.06898628e-01 2.98544168e-02 -7.70195350e-02 -1.01651996e-02 -6.43560523e-03 -3.24915871e-02 -3.37633230e-02 -4.32395115e-02 6.21578805e-02 -4.06050384e-02 3.89887802e-02 5.85224628e-02 -3.41907255e-02 -5.12122065e-02 4.50508026e-33 1.13116689e-01 -8.51072650e-03 -9.25030783e-02 2.20423657e-02 -5.66865280e-02 -1.57673378e-02 -4.67312261e-02 6.14579841e-02 -5.16407304e-02 8.90316516e-02 9.35158227e-03 6.35816082e-02 7.01287389e-02 -6.47543967e-02 5.41845523e-03 1.33848854e-03 3.79684120e-02 6.89031631e-02 -7.42482692e-02 6.36940971e-02 -4.75647375e-02 -7.84210023e-03 -8.18961766e-03 1.84128843e-02 -7.60232285e-03 4.76388149e-02 -1.72516294e-02 4.40721512e-02 -8.77779350e-02 -1.07916016e-02 -5.54142557e-02 4.88614663e-02 -7.83364996e-02 1.67492088e-02 -1.64383836e-02 6.06767647e-02 2.85736248e-02 -9.52064991e-02 2.51444126e-03 1.08555276e-02 -5.09450212e-02 -2.14771107e-02 1.52796790e-01 -4.27820459e-02 2.89093722e-02 -4.96570244e-02 -5.79501763e-02 2.82133855e-02 -3.25841643e-02 -1.75042581e-02 4.48866673e-02 3.40810381e-02 1.45224723e-04 4.81841005e-02 4.18299362e-02 -4.69190478e-02 -7.91866183e-02 -3.42712626e-02 -6.66711181e-02 -1.03458771e-02 -9.11988169e-02 6.67364569e-03 -1.45809017e-02 2.39232718e-03 4.44563944e-03 -1.05879204e-02 -2.78449301e-02 -3.49644162e-02 -2.46671233e-02 4.78203446e-02 -2.08226480e-02 -5.95815293e-02 -1.04035757e-01 -5.59097715e-02 3.86543684e-02 1.05137909e-02 3.55818383e-02 1.76445097e-02 -2.49957237e-02 6.66439608e-02 -5.30123264e-02 2.30047107e-02 1.73489191e-02 -2.07350925e-02 -1.95314400e-02 -9.51546058e-02 -5.02571231e-03 -6.35184050e-02 4.35592830e-02 7.26910308e-02 -2.75358688e-02 4.34854589e-02 -4.55433540e-02 3.32281180e-02 -2.56187879e-02 -1.89569533e-08 -3.73009965e-02 -8.29237700e-02 -6.99395388e-02 1.35674765e-02 -3.54312267e-03 -5.79407550e-02 7.41111040e-02 -4.22320478e-02 -1.28664151e-02 3.67892534e-02 4.58846651e-02 6.05496541e-02 -1.43572195e-02 4.88549098e-02 4.71242331e-02 -6.85540587e-02 -1.87133960e-02 2.15034857e-02 -1.62538309e-02 2.12593703e-03 6.09612726e-02 -2.16082833e-03 -1.72992963e-02 7.26746693e-02 5.70595860e-02 -7.01324781e-03 -5.68803120e-03 -4.84191664e-02 1.87250841e-02 6.47058412e-02 -2.53904760e-02 1.77653991e-02 -2.42894073e-03 -1.67992692e-02 -1.95208215e-03 -3.73651795e-02 2.69613508e-02 4.33779322e-02 -5.75020649e-02 -3.06685455e-02 -3.13655362e-02 1.78942177e-02 -5.40487245e-02 -1.98004525e-02 4.04947288e-02 -7.47318640e-02 4.45540212e-02 3.63072753e-02 -7.20079914e-02 1.16352001e-02 -1.22403568e-02 4.13236674e-03 7.82235861e-02 5.37100397e-02 -2.57694032e-02 -1.13108223e-02 -4.83092815e-02 -1.84191987e-02 2.60648411e-02 -1.37104897e-03 -5.31681590e-02 -5.36281103e-03 -8.10949728e-02 5.02133965e-02]"

var testVec = "[7.04972772e-03 5.02414182e-02 4.25032005e-02 7.66037684e-03 1.38861956e-02 -5.06629795e-02 6.76542819e-02 -2.84457617e-02 1.31871970e-02 2.67654448e-03 1.47917317e-02 3.72327724e-03\n -4.31662798e-02 7.99982697e-02 -4.01284583e-02 1.29409637e-02\n -5.16663007e-02 -1.54523775e-02 -1.63411051e-02 -8.98555815e-02 2.00941856e-03 2.23874860e-02 4.64275740e-02 -1.00059044e-02\n -9.55336075e-03 1.69510264e-02 2.90242694e-02 1.26351481e-02 5.61742438e-03 3.28313978e-03 -6.09411970e-02 4.55366820e-02\n -4.80476394e-02 3.48520130e-02 1.94992777e-02 1.11693732e-01\n -2.81404667e-02 2.46890839e-02 2.92644668e-02 -3.68338153e-02\n -2.93160992e-04 -2.33494230e-02 4.60582562e-02 3.84435505e-02\n -2.81164926e-02 -4.47361656e-02 1.38852596e-02 -4.39143218e-02 5.52257746e-02 -7.80669320e-03 -8.38374272e-02 -4.38982621e-02\n -1.06876500e-01 -4.17651758e-02 2.10487843e-02 3.37743498e-02 4.67804223e-02 -2.01665424e-02 1.82516724e-02 -5.37277646e-02\n -1.26344962e-02 -4.87845093e-02 -3.30535532e-03 7.56560937e-02 4.60630655e-02 6.75361529e-02 -5.45247495e-02 6.72420263e-02 3.43623222e-03 -2.84605660e-03 -4.39176820e-02 4.70046215e-02 3.28554064e-02 5.12785725e-02 -2.95292735e-02 -6.82747513e-02 3.88121307e-02 1.54688088e-02 2.72458307e-02 3.22653241e-02 5.84305897e-02 8.42151977e-03 2.19047405e-02 -3.51214519e-04 3.02266721e-02 -5.63031659e-02 8.42307287e-04 -5.30680791e-02 4.46109660e-03 -1.20090889e-02 -3.47829275e-02 -2.74839159e-02\n -7.76017606e-02 -4.17848341e-02 -7.69437030e-02 -7.35579953e-02 3.25483456e-02 -9.13551264e-03 -7.44323358e-02 9.23509598e-02 8.20160136e-02 8.83290842e-02 1.21775605e-01 6.51655793e-02\n -8.92627053e-03 6.26292871e-03 -1.41725652e-02 4.48262505e-02\n -3.76750194e-02 -1.01037547e-02 7.95374531e-03 -6.21890537e-02\n -1.94792338e-02 -2.05792598e-02 5.90130426e-02 2.82468833e-02 2.10204944e-02 5.13480008e-02 -7.10927770e-02 1.98227372e-02\n -3.14318314e-02 2.85596754e-02 1.10198623e-02 1.35006038e-02\n -3.28268223e-02 -3.70623954e-02 4.07550111e-02 -8.33133899e-33 7.99143091e-02 1.91951392e-03 5.33398129e-02 1.09138995e-01 5.23303337e-02 5.67684285e-02 1.54732419e-02 -2.40059271e-02\n -4.75775264e-02 -3.56218554e-02 9.94182006e-03 -1.61497295e-02\n -1.46621410e-02 4.26900759e-02 2.57156864e-02 1.42945023e-02\n -6.04831949e-02 7.91005269e-02 1.48109505e-02 2.28279419e-02\n -2.27924399e-02 -2.03431863e-02 2.42445730e-02 4.53186687e-04\n -7.45058572e-03 -1.77216306e-02 3.89350615e-02 -6.77623898e-02 2.91966889e-02 4.46319021e-02 3.02878525e-02 5.92431240e-02\n -4.74928990e-02 -5.23977764e-02 -1.78803282e-04 5.73264547e-02\n -2.97823716e-02 -6.51224852e-02 -1.16939340e-02 -1.14187002e-02 3.64265367e-02 9.98901669e-03 -1.47424201e-02 -6.14400618e-02\n -5.13155460e-02 1.12337377e-02 5.72699383e-02 4.05222178e-02\n -2.88236123e-02 3.82819995e-02 -6.06708415e-02 -3.26318704e-02\n -7.39154816e-02 -6.52207211e-02 3.48407328e-02 4.41301391e-02 7.64361545e-02 -3.56455147e-02 2.83838734e-02 3.50835621e-02 3.56317312e-02 -4.23184782e-02 3.22512886e-03 -1.60223600e-02 9.13613439e-02 2.26621497e-02 1.05809944e-03 -6.20193668e-02 1.40692266e-02 3.94426361e-02 -1.47704989e-01 6.62789419e-02 3.09851323e-03 -6.72212020e-02 -2.07778271e-02 -5.25447652e-02 3.82509269e-02 -1.18403248e-02 -7.19859004e-02 1.37628578e-02\n -2.23808326e-02 -7.65625238e-02 4.31324169e-03 -7.48914154e-03\n -7.50295892e-02 1.06298001e-02 -4.14059544e-03 -8.65084454e-02\n -2.42974553e-02 -2.51496192e-02 -6.57426193e-02 -1.04599297e-02 1.65069643e-02 -1.18801013e-01 -1.16041906e-01 5.76430838e-33\n -1.86184701e-02 -1.00984491e-01 5.24479300e-02 1.20143760e-02 7.10429028e-02 -8.21478963e-02 -7.87236914e-02 1.01430349e-01\n -4.14710008e-02 2.24006884e-02 -1.74332056e-02 3.51539776e-02 1.11158542e-01 -6.04929775e-03 1.23510342e-02 2.90571954e-02 5.67695647e-02 -1.16375173e-02 7.84166716e-03 4.00961526e-02 1.86478216e-02 -1.56231076e-02 2.30578780e-02 -1.25297380e-03\n -5.70107065e-02 7.10425302e-02 9.22402516e-02 -6.95522204e-02\n -2.99351271e-02 -2.41661188e-03 -2.17313077e-02 2.31056716e-02\n -1.13216944e-01 -3.06404177e-02 -1.13153145e-01 1.54821575e-01\n -3.35487500e-02 -3.56321409e-02 -1.59753498e-03 2.18609963e-02 5.57875377e-04 6.21427111e-02 5.89791611e-02 5.26033230e-02\n -4.19616662e-02 2.91864779e-02 9.70523246e-03 6.50221631e-02\n -4.49947380e-02 6.99959404e-04 -2.01908723e-02 2.29369774e-02 2.74980031e-02 -8.63190591e-02 5.89974411e-02 -2.43420433e-02\n -6.45887628e-02 1.51183340e-03 6.50147274e-02 6.56596059e-03\n -2.11919919e-02 9.49443411e-03 -6.12958185e-02 1.19193062e-01\n -6.07512556e-02 -2.85830181e-02 -7.56630599e-02 8.83854851e-02\n -1.10337719e-01 8.68905708e-03 -1.39117381e-02 -9.04615968e-03\n -1.13743827e-01 -7.40811229e-02 2.10456699e-02 6.97289109e-02 3.80976796e-02 -2.72413436e-03 6.67017419e-03 2.21982803e-02 6.50191084e-02 2.00221688e-02 3.67872305e-02 2.75211446e-02 2.88566761e-02 8.47805943e-03 -8.27350095e-02 1.62496716e-02\n -1.96306705e-02 -2.64610606e-03 2.23516971e-02 -2.89196111e-02\n -1.07017025e-01 -8.41408372e-02 -2.81797852e-02 -1.69628951e-08\n -9.89135541e-03 4.99667376e-02 3.54019292e-02 -4.13707234e-02 2.60854717e-02 7.96879604e-02 1.60869986e-01 -4.33730567e-03\n -8.89112726e-02 4.90754582e-02 -1.07060242e-02 5.25966985e-03\n -1.94701517e-03 1.08132251e-01 9.04670805e-02 -1.10407673e-01 8.55745822e-02 3.55964638e-02 -1.14811724e-02 1.15296721e-01 1.70270121e-03 9.87607613e-03 7.92697519e-02 -4.95526120e-02 2.53240205e-02 1.42348604e-03 -1.76120717e-02 -5.56596145e-02 3.75673920e-03 -2.49457881e-02 1.70281269e-02 9.47345123e-02 6.43210253e-03 -8.19704030e-03 -1.22901797e-02 -3.52434926e-02\n -1.87473111e-02 -2.74706110e-02 -4.32157591e-02 7.12674065e-03\n -8.01878143e-03 1.21374287e-01 2.75641270e-02 1.84895229e-02\n -3.06184441e-02 3.11777424e-02 9.91564691e-02 -1.23252980e-01\n -5.90321198e-02 4.81063174e-03 -3.02250888e-02 -2.66637523e-02 1.10746540e-01 1.09352753e-03 6.69997483e-02 -5.42565472e-02\n -4.26170863e-02 -9.04185977e-03 -5.38401902e-02 4.88289818e-02 5.99554926e-02 2.86387391e-02 -1.16192847e-01 -3.68212052e-02]\n"

func TestF2S(t *testing.T) {
	s := float64Slice2String([]float64{1.1, 2.6, 0.8})
	fmt.Println(s)
}

func TestS2F(t *testing.T) {
	f, err := strings2Float64Slice(testVector)
	if err != nil {
		t.Error(err)
	}
	fmt.Println(f)
}

func TestPGSql(t *testing.T) {
	conf := new(model.Config)
	path, err := os.Getwd()
	if err != nil {
		t.Fatalf("获取工作目录失败: %v", err)
	}
	jsonFile := filepath.Join(path, "../cmd/config.json")

	// 读取文件内容
	data, err := os.ReadFile(jsonFile)
	if err != nil {
		t.Fatalf("读取 JSON 文件失败: %v", err)
	}

	// 解析 JSON 为 mode.Conf
	if err := json.Unmarshal(data, conf); err != nil {
		t.Fatalf("解析 JSON 失败: %v", err)
	}

	t.Logf("读取配置成功: %+v", conf)
	dao, err := NewDao(conf)
	if err != nil {
		t.Fatalf("<UNK>: %v", err)
	}
	fs, _ := strings2Float64Slice(testVec)
	id, content, d, err := dao.SelectMostSimilarQuestionByGroup(1, fs)
	if err != nil {
		t.Fatalf("SelectMostSimilarQuestionByGroup error: %v", err)
	}
	fmt.Printf("id:%d, content:%s, distance:%v\n", id, content, d)
}

func TestPing(t *testing.T) {
	url := "http://192.168.10.157:8089/ping"

	// 创建 HTTP 客户端
	client := &http.Client{
		Timeout: 5 * time.Second,
	}

	// 发起请求
	resp, err := client.Get(url)
	if err != nil {
		fmt.Println("请求失败:", err)
		return
	}
	defer resp.Body.Close()

	// 读取响应内容
	body, err := io.ReadAll(resp.Body)
	if err != nil {
		fmt.Println("读取响应失败:", err)
		return
	}

	fmt.Printf("响应状态码: %d\n", resp.StatusCode)
	fmt.Printf("响应内容: %s\n", body)
}

func NewConfig() (conf *model.Config, err error) {
	f, err := os.Open("../cmd/config.json")
	if err != nil {
		panic(err)
	}
	defer f.Close()
	conf = new(model.Config)
	if err := json.NewDecoder(f).Decode(&conf); err != nil {
		panic(err)
	}
	return conf, nil
}

func Test(t *testing.T) {
	conf, err := NewConfig()
	if err != nil {
		t.Error(err)
	}
	dao, err := NewDao(conf)
	if err != nil {
		t.Fatalf("create Dao err: %v", err)
	}
	rooms, err := dao.SelectAllRooms()
	if err != nil {
		t.Fatalf("SelectAllRooms err: %v", err)
	}
	fmt.Println(rooms)
}
